<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="/valida.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VALIDATE CAE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Markdown parser -->
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <style>
    /* Custom scrollbar for chat */
    .chatbot-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chatbot-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .chatbot-messages::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      /* slate-300 */
      border-radius: 20px;
      border: 3px solid transparent;
    }

    /* Typing indicator animation */
    .typing-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 8px 12px;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #94a3b8;
      animation: typing-bounce 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(1) {
      animation-delay: -0.32s;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes typing-bounce {

      0%,
      80%,
      100% {
        transform: translateY(0);
        opacity: 0.5;
      }

      40% {
        transform: translateY(-8px);
        opacity: 1;
      }
    }
  </style>
  <script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom": "https://aistudiocdn.com/react-dom@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/"
  }
}
</script>
  <link rel="stylesheet" href="/index.css">
</head>

<body class="bg-slate-50 antialiased text-slate-800">
  <div id="root"></div>
  <script type="module" src="/index.tsx"></script>

  <!-- Validate Chatbot Widget -->
  <div id="validate-chat-container"></div>

  <script>
    ; (function () {
      const API_URL = 'https://server-chat-validate.vercel.app/api/chat'

      function getSessionId() {
        try {
          const stored = localStorage.getItem('validate_chat_session')
          if (stored) return stored
          const id = self.crypto?.randomUUID
            ? self.crypto.randomUUID()
            : 'sess_' + Math.random().toString(36).slice(2)
          localStorage.setItem('validate_chat_session', id)
          return id
        } catch {
          return 'anon_' + Math.random().toString(36).slice(2)
        }
      }

      const sessionId = getSessionId()
      const container = document.getElementById('validate-chat-container')
      if (!container) return

      // Function to check if user is logged in (main app is loaded)
      function isUserLoggedIn() {
        const root = document.getElementById('root')
        if (!root) return false
        // Check if the root has the main layout (not the login page)
        const hasMainLayout = root.querySelector('aside') !== null || root.querySelector('header') !== null
        return hasMainLayout
      }

      // Function to initialize the chatbot
      function initializeChatbot() {
        container.innerHTML = `
          <style>
            .validate-chat-button {
              position: fixed;
              bottom: 20px;
              right: 20px;
              width: 56px;
              height: 56px;
              border-radius: 9999px;
              border: none;
              background: #ea580c;
              color: #fff;
              box-shadow: 0 10px 30px rgba(0,0,0,0.25);
              cursor: pointer;
              font-size: 24px;
              z-index: 9999;
            }
            .validate-chat-widget {
              position: fixed;
              bottom: 20px;
              right: 20px;
              width: 460px;
              height: 600px;
              border-radius: 20px;
              box-shadow: 0 20px 60px rgba(0,0,0,0.25);
              background: #fff;
              display: none;
              flex-direction: column;
              overflow: hidden;
              border: 1px solid #e5e7eb;
              font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
              font-size: 14px;
              z-index: 9999;
            }
            .validate-chat-widget.open {
              display: flex;
            }
            .validate-chat-header {
              background: linear-gradient(135deg, #fb923c 0%, #ea580c 100%);
              color: #fff;
              padding: 10px 12px;
              display: flex;
              justify-content: space-between;
              align-items: center;
            }
            .validate-chat-messages {
              flex: 1;
              padding: 10px 12px;
              overflow-y: auto;
              background: #f8fafc;
            }
            .validate-chat-input {
              padding: 8px 10px;
              border-top: 1px solid #e5e7eb;
              display: flex;
              gap: 6px;
              align-items: center;
              background: #fff;
            }
            .validate-chat-input input {
              flex: 1;
              border-radius: 9999px;
              border: 1px solid #d1d5db;
              padding: 8px 12px;
              outline: none;
              font-size: 13px;
            }
            .validate-chat-input button {
              border-radius: 9999px;
              border: none;
              padding: 8px 14px;
              background: #ea580c;
              color: #fff;
              font-size: 13px;
              font-weight: 600;
              cursor: pointer;
            }
            .validate-chat-bubble {
              max-width: 80%;
              padding: 8px 10px;
              border-radius: 14px;
              line-height: 1.4;
              box-shadow: 0 2px 6px rgba(15,23,42,0.08);
              margin-bottom: 12px;
            }
            .validate-chat-bubble.user {
              margin-left: auto;
              background: #ea580c;
              color: #fff;
              box-shadow: 0 3px 8px rgba(234,88,12,0.35);
              white-space: pre-wrap;
            }
            .validate-chat-bubble.bot {
              margin-right: auto;
              background: #fff;
              color: #0f172a;
            }
            /* Markdown styles for bot messages */
            .validate-chat-bubble.bot p {
              margin: 0.5em 0;
            }
            .validate-chat-bubble.bot p:first-child {
              margin-top: 0;
            }
            .validate-chat-bubble.bot p:last-child {
              margin-bottom: 0;
            }
            .validate-chat-bubble.bot h1,
            .validate-chat-bubble.bot h2,
            .validate-chat-bubble.bot h3 {
              margin: 0.8em 0 0.4em 0;
              font-weight: 700;
            }
            .validate-chat-bubble.bot h1 { font-size: 1.3em; }
            .validate-chat-bubble.bot h2 { font-size: 1.2em; }
            .validate-chat-bubble.bot h3 { font-size: 1.1em; }
            .validate-chat-bubble.bot ul,
            .validate-chat-bubble.bot ol {
              margin: 0.5em 0;
              padding-left: 1.8em;
            }
            .validate-chat-bubble.bot ul {
              list-style-type: disc;
            }
            .validate-chat-bubble.bot ol {
              list-style-type: decimal;
            }
            .validate-chat-bubble.bot li {
              margin: 0.25em 0;
              display: list-item;
            }
            .validate-chat-bubble.bot code {
              background: #f1f5f9;
              padding: 2px 4px;
              border-radius: 3px;
              font-family: 'Courier New', monospace;
              font-size: 0.9em;
            }
            .validate-chat-bubble.bot pre {
              background: #f1f5f9;
              padding: 8px;
              border-radius: 6px;
              overflow-x: auto;
              margin: 0.5em 0;
            }
            .validate-chat-bubble.bot pre code {
              background: transparent;
              padding: 0;
            }
            .validate-chat-bubble.bot a {
              color: #ea580c;
              text-decoration: underline;
            }
            .validate-chat-bubble.bot strong {
              font-weight: 700;
            }
            .validate-chat-bubble.bot em {
              font-style: italic;
            }
            .validate-chat-bubble.bot blockquote {
              border-left: 3px solid #e5e7eb;
              padding-left: 10px;
              margin: 0.5em 0;
              color: #64748b;
            }
          </style>

          <button class="validate-chat-button" id="validate-chat-open">üí¨</button>

          <div class="validate-chat-widget" id="validate-chat-widget">
            <div class="validate-chat-header">
              <div style="font-weight:700;font-size:15px;letter-spacing:.03em;">
                Asistente Validate
              </div>
              <div style="display:flex;gap:8px;align-items:center;">
                <button id="validate-chat-restart" style="border:none;background:transparent;color:#fff;cursor:pointer;padding:4px;display:flex;align-items:center;justify-content:center;border-radius:4px;transition:background-color 0.2s;" title="Reiniciar conversaci√≥n" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.1)'" onmouseout="this.style.backgroundColor='transparent'">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                  </svg>
                </button>
                <button id="validate-chat-close" style="border:none;background:transparent;color:#fff;font-size:20px;cursor:pointer;padding:4px;display:flex;align-items:center;justify-content:center;border-radius:4px;transition:background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.1)'" onmouseout="this.style.backgroundColor='transparent'">
                  √ó
                </button>
              </div>
            </div>
            <div class="validate-chat-messages" id="validate-chat-messages"></div>
            <div class="validate-chat-input">
              <input id="validate-chat-input" placeholder="Escribe tu mensaje">
              <button id="validate-chat-send">Enviar</button>
            </div>
          </div>
        `

        const widget = document.getElementById('validate-chat-widget')
        const openBtn = document.getElementById('validate-chat-open')
        const closeBtn = document.getElementById('validate-chat-close')
        const restartBtn = document.getElementById('validate-chat-restart')
        const messagesEl = document.getElementById('validate-chat-messages')
        const inputEl = document.getElementById('validate-chat-input')
        const sendBtn = document.getElementById('validate-chat-send')

        // Configure marked to preserve line breaks
        marked.setOptions({
          breaks: true,
          gfm: true
        })

        // Show welcome message on load (using markdown format)
        const welcomeMessage = `üëã **Bienvenido al Asistente CAE de Validate.**

Estoy aqu√≠ para ayudarte a gestionar la Coordinaci√≥n de Actividades Empresariales sin errores y en menos tiempo.

Puedes preguntarme sobre:
- Alta de trabajadores o contratas
- Documentaci√≥n necesaria para acceder a un centro
- Qu√© hacer si una documentaci√≥n es rechazada

Tambi√©n puedo acompa√±arte paso a paso para:
- ‚úÖ Subir documentaci√≥n
- ‚úÖ Asociar trabajadores a centros
- ‚úÖ Resolver incidencias CAE

Solo dime qu√© necesitas y te gu√≠o.`
        addMessage(welcomeMessage, 'bot')

        function addMessage(text, from) {
          const div = document.createElement('div')
          div.className = 'validate-chat-bubble ' + from

          if (from === 'bot') {
            // Parse markdown for bot messages
            div.innerHTML = marked.parse(text)
          } else {
            // Plain text for user messages
            div.textContent = text
          }

          messagesEl.appendChild(div)
          messagesEl.scrollTop = messagesEl.scrollHeight
        }

        function showTypingIndicator() {
          const div = document.createElement('div')
          div.className = 'validate-chat-bubble bot typing-indicator'
          div.id = 'typing-indicator'
          div.innerHTML = '<span></span><span></span><span></span>'
          messagesEl.appendChild(div)
          messagesEl.scrollTop = messagesEl.scrollHeight
        }

        function hideTypingIndicator() {
          const indicator = document.getElementById('typing-indicator')
          if (indicator) {
            indicator.remove()
          }
        }

        async function send() {
          const text = inputEl.value.trim()
          if (!text) return

          addMessage(text, 'user')
          inputEl.value = ''

          // Show typing indicator
          showTypingIndicator()

          try {
            const res = await fetch(API_URL, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ text, sessionId })
            })

            const data = await res.json()

            // Hide typing indicator
            hideTypingIndicator()

            const msgs = data.messages || []
            if (!msgs.length) {
              addMessage('No he recibido respuesta del asistente.', 'bot')
            } else {
              msgs.forEach(t => addMessage(t, 'bot'))
            }
          } catch (e) {
            // Hide typing indicator on error
            hideTypingIndicator()
            addMessage('Error al conectar con el asistente.', 'bot')
          }
        }

        openBtn.addEventListener('click', () => {
          widget.classList.add('open')
          openBtn.style.display = 'none'
        })

        closeBtn.addEventListener('click', () => {
          widget.classList.remove('open')
          openBtn.style.display = 'block'
        })

        restartBtn.addEventListener('click', () => {
          messagesEl.innerHTML = ''
          addMessage(welcomeMessage, 'bot')
        })

        sendBtn.addEventListener('click', send)

        inputEl.addEventListener('keydown', e => {
          if (e.key === 'Enter') {
            e.preventDefault()
            send()
          }
        })
      }

      // Observer to detect when user logs in
      const observer = new MutationObserver(() => {
        if (isUserLoggedIn()) {
          initializeChatbot()
          observer.disconnect() // Stop observing once chatbot is initialized
        }
      })

      // Start observing if not already logged in
      if (isUserLoggedIn()) {
        initializeChatbot()
      } else {
        // Observe changes to the root element
        const root = document.getElementById('root')
        if (root) {
          observer.observe(root, { childList: true, subtree: true })
        }
      }
    })()
  </script>
</body>

</html>